<!-- frontend/components/notifications.html -->
<div class="notification-item">
    <div class="notification-icon loan">
      <i class="fas fa-hand-holding-usd"></i>
    </div>
    <div class="notification-content">
      <div class="notification-title">{{title}}</div>
      <div class="notification-message">{{message}}</div>
      <div class="notification-time">{{time}}</div>
    </div>
    {{#unless isRead}}
    <div class="notification-unread"></div>
    {{/unless}}
  </div>
  
  <script>
    // This is a template file that will be used to generate notification items
    // The actual loading and rendering of notifications will be handled in the main JavaScript files
    
    function createNotificationItem(notification) {
      // Get the template HTML
      const template = document.querySelector('#notification-template').innerHTML;
      
      // Replace placeholders with actual data
      const html = template
        .replace('{{title}}', notification.title)
        .replace('{{message}}', notification.message)
        .replace('{{time}}', window.app.timeAgo(new Date(notification.createdAt)))
        .replace('{{#unless isRead}}', notification.isRead ? '<!--' : '')
        .replace('{{/unless}}', notification.isRead ? '-->' : '');
      
      // Create a temporary container
      const container = document.createElement('div');
      container.innerHTML = html;
      
      // Return the first child (the notification item)
      return container.firstElementChild;
    }
    
    function loadNotifications() {
      const authToken = localStorage.getItem('authToken');
      if (!authToken) return;
      
      fetch('http://localhost:5000/api/notifications', {
        headers: {
          'Authorization': `Bearer ${authToken}`
        }
      })
      .then(response => response.json())
      .then(data => {
        const notifications = data.data;
        const notificationList = document.getElementById('notificationList');
        
        // Count unread notifications
        const unreadCount = notifications.filter(notification => !notification.isRead).length;
        
        // Update notification badge
        const notificationBadge = document.getElementById('notificationBadge');
        notificationBadge.textContent = unreadCount;
        notificationBadge.style.display = unreadCount > 0 ? 'flex' : 'none';
        
        // Clear notification list
        notificationList.innerHTML = '';
        
        if (notifications.length === 0) {
          notificationList.innerHTML = `
            <div style="padding: 15px; text-align: center; color: var(--text-light);">
              No notifications
            </div>
          `;
          return;
        }
        
        // Add notifications to list
        notifications.slice(0, 5).forEach(notification => {
          const notificationItem = createNotificationItem(notification);
          
          // Add click event listener to mark as read
          notificationItem.addEventListener('click', function() {
            markNotificationAsRead(notification._id);
          });
          
          notificationList.appendChild(notificationItem);
        });
      })
      .catch(error => {
        console.error('Error loading notifications:', error);
      });
    }
    
    function markNotificationAsRead(notificationId) {
      const authToken = localStorage.getItem('authToken');
      if (!authToken) return;
      
      fetch(`http://localhost:5000/api/notifications/${notificationId}/read`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          // Reload notifications to update UI
          loadNotifications();
        }
      })
      .catch(error => {
        console.error('Error marking notification as read:', error);
      });
    }
    
    function markAllNotificationsAsRead() {
      const authToken = localStorage.getItem('authToken');
      if (!authToken) return;
      
      fetch('http://localhost:5000/api/notifications/read-all', {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${authToken}`,
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (response.ok) {
          // Reload notifications to update UI
          loadNotifications();
        }
      })
      .catch(error => {
        console.error('Error marking all notifications as read:', error);
      });
    }
    
    // Set up notification event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Notification toggle
      const notificationToggle = document.getElementById('notificationToggle');
      const notificationContainer = document.getElementById('notificationContainer');
      
      if (notificationToggle && notificationContainer) {
        notificationToggle.addEventListener('click', function(e) {
          e.preventDefault();
          notificationContainer.style.display = notificationContainer.style.display === 'block' ? 'none' : 'block';
          
          // Load notifications when opening the panel
          if (notificationContainer.style.display === 'block') {
            loadNotifications();
          }
        });
        
        // Close notification panel when clicking outside
        document.addEventListener('click', function(e) {
          if (!notificationToggle.contains(e.target) && !notificationContainer.contains(e.target)) {
            notificationContainer.style.display = 'none';
          }
        });
      }
      
      // Mark all as read button
      const markAllReadBtn = document.getElementById('markAllRead');
      if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', function() {
          markAllNotificationsAsRead();
        });
      }
      
      // Load notifications on page load
      loadNotifications();
      
      // Set up interval to check for new notifications every minute
      setInterval(loadNotifications, 60000);
    });
  </script>
  
  <!-- Hidden template for notifications -->
  <script type="text/template" id="notification-template">
  <div class="notification-item">
    <div class="notification-icon {{type}}">
      <i class="fas fa-bell"></i>
    </div>
    <div class="notification-content">
      <div class="notification-title">{{title}}</div>
      <div class="notification-message">{{message}}</div>
      <div class="notification-time">{{time}}</div>
    </div>
    {{#unless isRead}}
    <div class="notification-unread"></div>
    {{/unless}}
  </div>
  </script>